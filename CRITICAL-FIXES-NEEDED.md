# üî¥ –ö–†–ò–¢–ò–ß–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –î–õ–Ø Z2K

**–î–∞—Ç–∞:** 2026-01-28
**–°—Ç–∞—Ç—É—Å:** PRE-ALPHA - –¢—Ä–µ–±—É—é—Ç—Å—è –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

---

## üö® –¢–û–ü-3 –ö–†–ò–¢–ò–ß–ù–´–• –ü–†–û–ë–õ–ï–ú

### 1. üî¥ **–ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–´ –°–ò–°–¢–ï–ú–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï**

**–ü—Ä–æ–±–ª–µ–º–∞:**
```bash
# z2k –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç check_system()
# –†–µ–∑—É–ª—å—Ç–∞—Ç: SYSTEM, UNAME, SUBSYS, INIT –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
# –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ: –ú–æ–¥—É–ª–∏ common/ –Ω–µ –º–æ–≥—É—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```bash
# –í z2k.sh –ø–æ—Å–ª–µ source_modules():
echo "* Initializing system environment"
. "${ZAPRET2_DIR}/common/installer.sh"
check_system 1
export SYSTEM SUBSYS UNAME INIT SYSTEMCTL
```

**–ì–¥–µ –¥–æ–±–∞–≤–∏—Ç—å:** `z2k.sh:478` –ø–æ—Å–ª–µ `source_modules()`

---

### 2. üî¥ **–ù–ï–¢ –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–ü–ò–°–ö–û–í –î–û–ú–ï–ù–û–í**

**–ü—Ä–æ–±–ª–µ–º–∞:**
```bash
# z2k –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç crontab_add()
# –†–µ–∑—É–ª—å—Ç–∞—Ç: –°–ø–∏—Å–∫–∏ –¥–æ–º–µ–Ω–æ–≤ –ù–ï –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
# –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ: –ù–æ–≤—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –†–ö–ù –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—é—Ç—Å—è
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```bash
# –í lib/install.sh –≤ –∫–æ–Ω—Ü–µ step_finalize():
print_info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤..."
. "${ZAPRET2_DIR}/common/installer.sh"
crontab_del_quiet
crontab_add 0 6    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ 06:00
cron_ensure_running
print_success "–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ"
```

**–ì–¥–µ –¥–æ–±–∞–≤–∏—Ç—å:** `lib/install.sh:1727` –≤ –∫–æ–Ω—Ü–µ `step_finalize()`

---

### 3. üü° **LOW RAM –°–ò–°–¢–ï–ú–´ –ú–û–ì–£–¢ –ü–û–õ–£–ß–ò–¢–¨ OOM**

**–ü—Ä–æ–±–ª–µ–º–∞:**
```bash
# z2k –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç ask_config_tmpdir()
# –†–µ–∑—É–ª—å—Ç–∞—Ç: /tmp (tmpfs –≤ –ø–∞–º—è—Ç–∏) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
# –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ: –ù–∞ —Ä–æ—É—Ç–µ—Ä–∞—Ö ‚â§400MB RAM –º–æ–∂–µ—Ç –Ω–µ —Ö–≤–∞—Ç–∏—Ç—å –ø–∞–º—è—Ç–∏
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```bash
# –í lib/install.sh –≤ run_full_install() –ø–µ—Ä–µ–¥ step_create_config_and_init():
if [ $(get_ram_mb) -le 400 ]; then
    print_warning "Low RAM: $(get_ram_mb) MB"
    printf "Use /opt/zapret2/tmp instead of /tmp? [Y/n]: "
    read -r answer </dev/tty
    case "$answer" in
        [Nn]*) TMPDIR="" ;;
        *) TMPDIR="/opt/zapret2/tmp"; mkdir -p "$TMPDIR" ;;
    esac
    write_config_var TMPDIR
fi
```

**–ì–¥–µ –¥–æ–±–∞–≤–∏—Ç—å:** `lib/install.sh:1750` –ø–µ—Ä–µ–¥ `step_create_config_and_init()`

---

## üìã –ë–´–°–¢–†–´–ô CHECKLIST –ü–ï–†–ï–î –†–ï–õ–ò–ó–û–ú

- [ ] ‚úÖ `check_system()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è ‚Üí SYSTEM, UNAME —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- [ ] ‚úÖ `crontab_add()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è ‚Üí –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] ‚ö†Ô∏è `ask_config_tmpdir()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è ‚Üí low RAM –∑–∞—â–∏—Ç–∞
- [ ] ‚ö†Ô∏è `dry_run_nfqws()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è ‚Üí –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ–ø—Ü–∏–π
- [ ] ‚ö†Ô∏è `select_ipv6()` –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –º–µ–Ω—é ‚Üí –ø–æ–¥–¥–µ—Ä–∂–∫–∞ IPv6
- [ ] ‚ö†Ô∏è `default_files()` —Å–æ–∑–¥–∞—ë—Ç template —Ñ–∞–π–ª—ã ‚Üí UX –ª—É—á—à–µ

---

## üéØ –ü–†–ò–û–†–ò–¢–ï–¢–´

### üî¥ MUST FIX (–±–ª–æ–∫–µ—Ä—ã —Ä–µ–ª–∏–∑–∞):
1. –î–æ–±–∞–≤–∏—Ç—å `check_system()` - –±–µ–∑ —ç—Ç–æ–≥–æ common/ –º–æ–¥—É–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç
2. –î–æ–±–∞–≤–∏—Ç—å `crontab_add()` - –±–µ–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è

### üü° SHOULD FIX (–≤–∞–∂–Ω–æ –¥–ª—è production):
3. –î–æ–±–∞–≤–∏—Ç—å `ask_config_tmpdir()` - –¥–ª—è —Ä–æ—É—Ç–µ—Ä–æ–≤ —Å –º–∞–ª—ã–º RAM
4. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é `dry_run_nfqws()` - –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å –æ—à–∏–±–∫–∏ —Ä–∞–Ω—å—à–µ

### üü¢ NICE TO HAVE (—É–ª—É—á—à–µ–Ω–∏—è UX):
5. –î–æ–±–∞–≤–∏—Ç—å `select_ipv6()` –≤ –º–µ–Ω—é - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ IPv6 –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
6. –î–æ–±–∞–≤–∏—Ç—å `default_files()` - template —Ñ–∞–π–ª—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
7. –î–æ–±–∞–≤–∏—Ç—å `ask_config_offload()` - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
echo "SYSTEM=$SYSTEM UNAME=$UNAME"    # –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–µ –ø—É—Å—Ç—ã–µ

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å crontab
crontab -l | grep zapret                # –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–ø–∏—Å—å

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å TMPDIR –Ω–∞ low RAM
[ $(get_ram_mb) -le 400 ] && {
    grep TMPDIR /opt/zapret2/config    # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å /opt/zapret2/tmp
}

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–ø–∏—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
/opt/zapret2/ipset/get_config.sh       # –î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å

# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å init —Å–∫—Ä–∏–ø—Ç
/opt/etc/init.d/S99zapret2 start       # –î–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
ps | grep nfqws2                       # –ü—Ä–æ—Ü–µ—Å—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å
```

---

## üìä –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–° Z2K

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|-----------|--------|-------------|
| Bootstrap —Å–∏—Å—Ç–µ–º–∞ | ‚úÖ OK | –†–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ |
| –ú–æ–¥—É–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ | ‚úÖ OK | –°–∫–∞—á–∏–≤–∞–µ—Ç—Å—è —Å GitHub |
| –£—Å—Ç–∞–Ω–æ–≤–∫–∞ zapret2 | ‚úÖ OK | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç install_bin.sh |
| –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ | ‚ùå FAIL | **SYSTEM, UNAME –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã** |
| –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ | ‚ùå FAIL | **crontab –Ω–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è** |
| Low RAM –∑–∞—â–∏—Ç–∞ | ‚ö†Ô∏è WARN | tmpdir –Ω–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è |
| Init —Å–∫—Ä–∏–ø—Ç | ‚úÖ OK | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç common/ –º–æ–¥—É–ª–∏ |
| –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ | ‚úÖ OK | 458 —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —Ä–∞–±–æ—Ç–∞—é—Ç |
| Multi-profile | ‚úÖ OK | TCP+UDP –ø—Ä–æ—Ñ–∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è |

**–ò—Ç–æ–≥:** z2k —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ Keenetic, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç **2 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è** –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º –∏–∑ PRE-ALPHA.

---

## üí° –ë–´–°–¢–†–´–ô FIX (–º–∏–Ω–∏–º—É–º –¥–ª—è —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏)

**–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å—Ä–æ—á–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å:**

1. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SYSTEM –≤—Ä—É—á–Ω—É—é:**
```bash
export SYSTEM=linux
export UNAME=Linux
export SUBSYS=
echo "SYSTEM=$SYSTEM" >> /opt/zapret2/config
```

2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å cron –≤—Ä—É—á–Ω—É—é:**
```bash
crontab -l 2>/dev/null > /tmp/cron.tmp
echo "0 6 * * * /opt/zapret2/ipset/get_config.sh" >> /tmp/cron.tmp
crontab /tmp/cron.tmp
rm /tmp/cron.tmp
```

3. **–î–ª—è low RAM —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å TMPDIR:**
```bash
echo "TMPDIR=/opt/zapret2/tmp" >> /opt/zapret2/config
mkdir -p /opt/zapret2/tmp
```

**–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ z2k –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ.**

---

**–ö–æ–Ω–µ—Ü**
